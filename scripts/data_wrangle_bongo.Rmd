---
title: "2019 IYS - Bongo Data wrangle"
author: "Tim van der Stap"
date: "6/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(obistools)
library(worrms)
library(lubridate)
library(janitor)
library(readxl)
library(here)
library(parsedate)
library(googledrive)
library(uuid)
library(gtools)
```

This .Rmd file describes the workflow to standardize the 2019 and 2020 zooplankton taxonomy and abundance data from the International Year of the Salmon High Seas Expeditions to Darwin Core, to allow publication to the Ocean Biodiversity Information System (OBIS). This file is divided into three sections that describe creating the following data tables: 1) Event Core, 2) occurrence extension and 3) extended measurement or fact extension. The script uses the following data sources:

__Metadata__:

* /original_data/IYS cruise logbook_2019.xlsx
* /original_data/Bongo2020_metadata.xlsx

__Data__: 

* /original_data/IYSZoopAbund2019_2020Long.csv
* /original_data/IYSKaganoSpecRemovedfromNet.csv

## Section 1. Event Core

The 2019 and 2020 zooplankton data is collected during multiple sampling events, where a paired bongo net is deployed and retrieved vertically. Given this set up, we standardize the data with an Event data file at it's core. This data table will include metadata on the sampling event (date, time, geographic coordinates, sampling effort). We have to make sure that the date/time follows the ISO-8601 standards, and that all sampling events have a unique identifier (eventID) under which the other data files will be nested.

``` {r data wrangle, warning = FALSE}
bongo_2019 <- read_excel(here("original_data", "IYS cruise logbook_2019.xlsx"),
                             sheet = "Bongo metadata") %>%
  janitor::clean_names() %>% 
  mutate(Date = lubridate::ymd(date),
         Time = format(time, format = "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time), 
                                               format="%Y-%m-%d %H:%M:%S", 
                                               tz="Asia/Kamchatka")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")) %>%
  dplyr::rename(net = net_number,
                sampleSizeValue = final_volume_filtered,
                fieldNotes = notes)

bongo_2019 <- bongo_2019 %>%
  filter(net == 1) %>%
  mutate(eventID = paste("IYS2019", "Kaganovsky", station, "Bongo", net, sep = "-"),
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters") %>%
  distinct()

bongo_2020 <- read_excel(here("original_data", "Bongo2020_metadata.xlsx"),
                         sheet = "Bongo metadata") %>%
  janitor::clean_names() %>%
  mutate(Date = lubridate::ymd(date),
         Time = format(time, format = "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "America/Los_Angeles")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")) %>%
  dplyr::rename(net = net_number,
                fieldNotes = notes)

bongo_2020[2] <- lapply(bongo_2020[2], function (x) {
  x1 <- type.convert(as.character(x), as.is = TRUE)
  ifelse(grepl("^[0-9.]+$", x1), round(as.numeric(x1)), x1)}
)

# As per Joanne Breckenridge (UBC): "where flowmeter-estimated volume is less than 50% of depth-estimated volume, we use the depth-estimated volume to calculate the abundance". 

bongo_2020 <- bongo_2020 %>%
  filter(net == 1) %>%
  mutate(sampleSizeValue = ifelse(flowmeter_vs_depth_estimated_ratio <= 0.5, depth_estimated_volume_filtered_m3,
                                  flowmeter_volume_filtered_m3),
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters",
         eventID = paste("IYS2020", "Legacy", station, gear, net, sep = "-")) %>%
  distinct() %>%
  rename(depth = depth_m,
         sample_depth = sample_depth_m,
         revs = revolutions,
         tow_distance = tow_distance_m,
         flowmeter_volume_filtered = flowmeter_volume_filtered_m3,
         depth_estimated_volume_filtered = depth_estimated_volume_filtered_m3) %>%
  mutate(qf = NA,
         sub_sample = NA)

bongo <- rbind(bongo_2019, bongo_2020)

bongo$year <- as.numeric(format(as.Date(bongo$eventDate), "%Y"))
bongo$month <- as.numeric(format(as.Date(bongo$eventDate), "%m"))
bongo$day <- as.numeric(format(as.Date(bongo$eventDate), "%d"))

# It was a vertical Bongo tow, and hence the minimumDepth is 0 m. 
bongo_fnl <- bongo %>%
  select(eventID,
         eventDate,
         year,
         month,
         day,
         decimalLatitude = latitude,
         decimalLongitude = longitude,
         maximumDepthInMeters = sample_depth,
         sampleSizeValue,
         samplingEffort,
         sampleSizeUnit,
         fieldNotes) %>%
  mutate(minimumDepthInMeters = 0) %>%
  distinct(eventID, .keep_all = TRUE)

bongo_fnl <- bongo_fnl %>% 
  mutate(footprintWKT = paste("POINT"," (", bongo_fnl$decimalLongitude, " ", bongo_fnl$decimalLatitude, ")"),
         coordinateUncertaintyInMeters <- obistools::calculate_centroid(footprintWKT)[3]) %>%
  mutate(geodeticDatum = "WGS84",
         language = "en",
         modified = lubridate::today(),
         bibliographicCitation = "Hunt, B., Mahara, N., & Pakhomov, E. (2023). Zooplankton Bongo Net Data from the 2019 and 2020 Gulf of Alaska International Year of the Salmon Expeditions [Data set]. North Pacific Anadromous Fish Commission. https://doi.org/10.21966/7cmt-ca72",
         datasetID = "https://doi.org/10.21966/7cmt-ca72",
         license = "https://creativecommons.org/licenses/by/4.0/legalcode",
         informationWithheld = "Contact data provider for information on abundance, sizes and biomass.",
         institutionID = "https://edmo.seadatanet.org/report/2220",
         institutionCode = "UBC-EOAS")

# Remove NAs from the Event Core:
bongo_fnl[is.na(bongo_fnl)] <- ""
bongo_fnl <- as.data.frame(bongo_fnl)

# Make sure the folder path exists already (e.g. ./Bongo/tidy_data)
write_csv(bongo_fnl, here("standardized_data", "bongo2019_2020_event.csv"))
```

## Section 2. Occurrence extension.

In the following section we develop an occurrence extension that will be nested under the Event Core. The occurrence extension will have unique occurrenceIDs that are associated with a specific observation of a taxa/lifestage/sex combination at a sampling station. These occurrenceIDs will therefore follow a similar format to the eventIDs and be nested under these IDs. On April 4, 2023 we received updated information from Joanne Breckenridge (UBC) to be included in the occurrence table. The occurrenceIDs will have data on taxa (identified to the lowest rank practical), developmental stage and sex. The observed taxa are cross referenced to the WoRMS database. For this to happen, some ids have been modified slightly, however the original recording of the taxa has been preserved under _verbatimIdentification_. 

``` {r bongo2019 abundance occ, warning = FALSE}
bongo_abun <- read.csv(here("original_data", "IYSZoopAbund2019_2020Long.csv")) %>%
  janitor::clean_names()

# Add additional data from Joanne Breckenridge. Create dummy columns for latitude and longitude to be populated later:
bongo_kag <- read.csv(here("original_data", "IYSKaganoSpecRemovedfromNet.csv")) %>%
  janitor::clean_names() 
bongo_kag$station <- as.character(bongo_kag$station)

bongo_abun <- bind_rows(bongo_abun, bongo_kag)

bongo_abun$net <- 1
bongo2019_abun <- subset(bongo_abun, date >= "2019-02-19" & date <= "2019-03-15") %>%
  mutate(eventID = paste("IYS2019", "Kaganovsky", station, "Bongo", net, sep = "-"))
bongo2020_abun <- subset(bongo_abun, date >= "2020-03-12" & date <= "2020-04-04") %>%
  mutate(eventID = paste("IYS2020", "Legacy", station, "Bongo", net, sep = "-"))

bongo_abun <- rbind(bongo2019_abun, bongo2020_abun)
```

The following section is per Joanne Breckenridge to improve the estimates for the abundance data associated with certain observed taxa:

```{r, warning = FALSE, message = FALSE}
bongo_abun$flowProp <- bongo_abun$vol_flow_est/bongo_abun$vol_depth_est

bongo_abun <- bongo_abun %>% 
  mutate(abundance = case_when(
    flowProp >= 0.5 ~ abund_m3_flow_est,
    flowProp < 0.5 ~ abund_m3_depth_est))

bongo_abun <- bongo_abun %>% 
  mutate(abundance = case_when(
    id == 'Primno pacifica' ~ abundance/12,
    id != 'Primno  pacifica' ~ abundance))

# working on combined zoop data

bongo_abun$id[bongo_abun$id == 'Primno pacifica' ] <- 'Primno abyssalis'
bongo_abun$id[bongo_abun$id == 'Scaphocalanus brevicaudatus' ] <- 'Spinocalanus brevicaudatus'

bongo_abun <- bongo_abun %>% 
  mutate(vessel = case_when(
    yearletter == "A" ~ "Kaganovsky",
    yearletter == "B" ~ "Legacy"))

# Calanus correction for C4-C6:
bongo_abun$id[bongo_abun$id == "Calanus marshallae" & bongo_abun$station %in% c("P", "Q")] <- "Calanus marshallae C4-C6"

# Change Taxon of all remaining C. marshallae C4-C6 from 2019 and 2020 to Neocalanus
bongo_abun$id[bongo_abun$vessel %in% c("Kaganovsky", "Legacy") & bongo_abun$id == "Calanus marshallae" & bongo_abun$stage %in% c("C4", "C5", "C6") ] <- "Neocalanus flemingeri/plumchrus C4-C6"

bongo_abun <- bongo_abun %>%
  group_by(eventID, vessel, station, ind_total, id, sf_proc, stage, sex) %>%
  summarise(abundance = sum(abundance)) %>%
  ungroup()

#At LegacyQ, 100% of C.marsh remain as C.marsh
#At LegacyP, 77% of C.marsh go to N. flem/plum

x <- bongo_abun %>%
  subset(id == "Calanus marshallae C4-C6" & station == "P")

v <- x$abundance

y <- bongo_abun %>%
  subset(id == 'Neocalanus flemingeri/plumchrus C4-C6' & station =='P')

w <- y$abundance

bongo_abun$abundance[bongo_abun$id == "Calanus marshallae C4-C6" & bongo_abun$station == "P"] <- v*0.33
bongo_abun$abundance[bongo_abun$id == 'Neocalanus flemingeri/plumchrus C4-C6' & bongo_abun$station == 'P'] <- v*0.77+w

#Combine Calanus C1-C3 and Neocalanus C1-C3 due to likely confusion in 2019 and 2020.

bongo_abun$id[bongo_abun$id == 'Calanus sp.' & bongo_abun$stage %in% c("C1", "C2", "C3")] <- 'Neocalanus+Calanus C1-C3'
bongo_abun$id[bongo_abun$id == 'Neocalanus sp.' & bongo_abun$stage %in% c("C1", "C2", "C3")] <- 'Neocalanus+Calanus C1-C3'
```

Manual inspection of the `bongo_abun` dataframe shows that there are still a few species (id) that will need slight changes in their spelling, as the worrms package does not recognize 'sp.' etc. Additionally, some ids contain a lifestage (larvae, egg, trochophores, etc). These are also mentioned in a column 'lifestage', so they are removed from the species id. These manual changes are listed below and are not made in the raw data file used (`IYSZoopabund2019_2020Long.csv`). This way the original species description is still provided. We ensure we keep the original recording of the observation in the column _verbatimIdentification_.

```{r, message = FALSE}

bongo_abun$verbatimIdentification = bongo_abun$id
bongo_abun$identificationQualifier <- ifelse(grepl("Neocalanus\\+Calanus C1\\-C3|Neocalanus flemingeri/plumchrus C4-C6",
                                                   bongo_abun$verbatimIdentification), "sp. indet.", NA)
bongo_abun$identificationQualifier <- ifelse(grepl("sp.|spp.", bongo_abun$id), "sp. indet.", NA)


# Joanne Breckenridge provided additional information regarding sp. and spp. to be included in the identificationRemarks:
bongo_abun <- bongo_abun %>% 
  mutate(identificationRemarks = case_when(
    grepl("sp.", bongo_abun$id) ~ "Taxonomist suspects that the individuals are all a single species, but unsure which species.",
    grepl("spp.", bongo_abun$id) ~ "It was not possible to distinguish the early developmental stages of the species within the genus."
  ))
bongo_abun$id <- gsub("\\b sp.\\b|\\b spp.\\b", "", bongo_abun$id)
bongo_abun$id <- gsub("egg|nauplius|larva|juvenile|calyptopsis|furcillia", "", bongo_abun$id)

# In the sex column there is 'juvenile' which should be in lifestage:
bongo_abun$stage <- ifelse(bongo_abun$sex == "juvenile" & is.na(bongo_abun$stage), "juvenile", bongo_abun$stage)
bongo_abun$sex <- gsub("juvenile", NA, bongo_abun$sex)

# Rename id column to verbatimIdentification, and duplicate it to a 'scientificname' column:
bongo_abun <- bongo_abun %>%
  mutate(scientificname = id) %>%
  mutate(scientificname = stringr::str_trim(scientificname, "right"))

# Make adjustments to the stage column:
bongo_abun$stage[bongo_abun$stage == "<0.5mm"] <- NA
bongo_abun$stage[bongo_abun$stage == "<1mm"] <- NA
bongo_abun$stage[bongo_abun$stage == "1mm"] <- NA
bongo_abun$stage[bongo_abun$stage == "s0"] <- NA
bongo_abun$stage[bongo_abun$stage == "napulius"] <- "nauplius"

unique_spp <- unique(bongo_abun$scientificname)
worms_id <- worrms::wm_records_names(unique(bongo_abun$scientificname), marine_only = FALSE) %>% dplyr::bind_rows()

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(bongo_abun, worms_id, by = "scientificname") %>% filter(is.na(AphiaID)) %>% distinct(scientificname)
```

These species listed in the the `no_worms_id` table will need to have their names changed in the original dataframe (bongo_abun) which we'll do below. I write this out so it is clear which names or species observations have been altered, so this can be verified. Verification has been done with the data provider.  

``` {r, message = FALSE}
bongo_abun$scientificname <- gsub("^Chaetognath$", "Chaetognatha", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Disconchoecia elegans", "Discoconchoecia elegans", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Euphausiid", "Euphausiidae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Doliolid", "Doliolidae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Oikopleura labradoriensis", "Oikopleura (Vexillaria) labradoriensis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Copepod", "Copepoda", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Mesocalanus tenucornis", "Mesocalanus tenuicornis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Oikopleura dioica", "Oikopleura (Vexillaria) dioica", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Ophuroidea", "Ophiuroidea", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Scaphocalanus brevicaudatus", "Spinocalanus brevicaudatus", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Siphonophore", "Siphonophorae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Polychaete", "Polychaeta", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Trochophore", "Animalia", bongo_abun$scientificname) 
bongo_abun$scientificname <- gsub("Fish", "Pisces", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Muggiae atlantica", "Muggiaea atlantica", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Gastropod", "Gastropoda", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Triconia ivlevi", "Triconia borealis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Squid", "Teuthida", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Epicarid isopod", "Epicaridea", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Tessarabrachion occulatum", "Tessarabrachion oculatum", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Euphausiid", "Euphausiidae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Nematocelis difficilis", "Nematoscelis difficilis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Tuscaretta globulosa", "Tuscaretta globosa", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Bivalve", "Bivalvia", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Symbolophorous californiensis", "Symbolophorus californiensis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Primno pacifica", "Primno abyssalis", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Aglama elegans", "Agalma elegans", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Ctenophore", "Ctenophora", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Euchirella curticaudata", "Euchirella curticauda", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Rhynchonereella angellini", "Rhynchonereella angelini", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Nematode", "Nematoda", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Calanoid A", "Calanoida", bongo_abun$scientificname)
# Because I changed Chaetognath earlier, it changed the code below which I had to alter. (rewrite this). 
bongo_abun$scientificname <- gsub("Chaetognath sp. (no heads)", "Chaetognatha", bongo_abun$scientificname, fixed = TRUE)
bongo_abun$scientificname <- gsub("\\bNeocalanus/Calanus\\b", "Calanidae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Neocalanus\\+Calanus C1\\-C3", "Calanidae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Neocalanus flemingeri/plumchrus C4-C6", "Neocalanus", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("Calanus marshallae C4-C6", "Calanus marshallae", bongo_abun$scientificname)
bongo_abun$scientificname <- gsub("^Euphausiidaeae$", "Euphausiidae", bongo_abun$scientificname)

# As we have now changed all the names in the original dataframe (bongo2019_abun) to fit the entries in the WoRMS database registry, we can use worrms::wm_records_names() again to find all the taxonomic information. 
bongo_worms_id <- worrms::wm_records_names(unique(bongo_abun$scientificname), marine_only = FALSE) %>%
  dplyr::bind_rows()

# Find the entries with multiple AphiaIDs:
dup_entries <- bongo_worms_id %>%
  group_by(scientificname) %>%
  filter(n() > 1)

# After manual inspection, there are some AphiaIDs that need to be removed as they are either duplicates, or alternate representations. 
bongo_worms_id <- filter(bongo_worms_id, !(AphiaID %in% c("534090", "426434", "719191", "1558566", "603038", "956054", "956065", "163921", 
                                                          "1434994", "106331", "605966", "138835")))

# Make sure that now all the species have a - single - associated AphiaID:
dup_entries <- bongo_worms_id %>%
  group_by(scientificname) %>%
  filter(n() > 1)

#TODO: Fix this:
bongo_abun$scientificname <- gsub("Euphausiidaeaeae", "Euphausiidae", bongo_abun$scientificname)

no_worms_id_2 <- left_join(bongo_abun, bongo_worms_id, by = "scientificname") %>% filter(is.na(AphiaID)) %>% distinct(scientificname)

```

Merge this dataset back into original dataframe. 

``` {r, message = FALSE}

bongo_abun <- left_join(bongo_abun, bongo_worms_id, by = "scientificname")
bongo_abun <- bongo_abun %>%
  select(eventID,
         verbatimIdentification,
         scientificName = scientificname,
         scientificNameID = lsid,
         authority,
         individualCount = ind_total,
         abundance,
         lifeStage = stage,
         sex,
         taxonRank = rank,
         taxonomicStatus = status,
         identificationQualifier,
         kingdom, phylum, class, order, family, genus,
         identificationRemarks) %>%
  group_by(eventID) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present",
         basisOfRecord = "PreservedSpecimen") %>%
  ungroup()

bongo_abun <- bongo_abun %>%
  mutate(authority = str_replace(authority, "\\(|\\)", ""),
         scientificName = ifelse(!is.na(authority),
                                 paste0(scientificName, " (", authority, ")"),
                                 scientificName)) %>%
  rename(scientificNameAuthorship = authority)

# In the occurrence data file there is no field to include abundance.
bongo_occ <- bongo_abun %>% select(-abundance)

# Check for duplicated occurrenceIDs:
bongo_occ %>% janitor::get_dupes(occurrenceID) # Should be none!

# Remove NAs from the Event Core:
bongo_occ[is.na(bongo_occ)] <- ""
bongo_occ <- as.data.frame(bongo_occ)

# Make sure the folder path exists already (e.g. ./Bongo/tidy_data)
write_csv(bongo_occ, here("standardized_data", "bongo2019_2020_occ.csv"))
```

## Section 3. extended measurementOrFact (eMOF) extension:

Add information on the sampling effort (the volume of sea water filtered, tow distance and speed of tow). The volume of sea water filtered is measured or estimated both from the flowmeter as well as from the depth-estimate. However the overall volume_filtered used to calculate the abundance is dependent on whether the flowmeter_volume_filtered/depth_estimated_volume_filtered is >= or < 0.5. 

We create two tables which we eventually merge together into a single eMOF data table. The first table will be specific to information that can be nested under the eventID of the sampling event. This is information on the volume filtered, speed of tow and tow distance. The second table provides further information on taxa abundance, as well as controlled vocabulary for associated sex and developmental stages. 

``` {r eMOF Bongo abundance, warning = FALSE, message = FALSE}

bongo <- bongo %>%
  mutate(volume_filtered = case_when(
    flowmeter_vs_depth_estimated_ratio >= 0.5 ~ flowmeter_volume_filtered,
    flowmeter_vs_depth_estimated_ratio < 0.5 ~ depth_estimated_volume_filtered))

bongo_sampling <- bongo %>%
  select(eventID,
         tow_distance,
         volume_filtered) %>%
  mutate(speed_tow = 1) %>%
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate_all(as.character) %>%
  pivot_longer(cols = tow_distance:speed_tow,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(eventID, "bongo", measurementType, sep = "-"),
         measurementTypeID = case_when(
           measurementType == "tow_distance" ~ "http://vocab.nerc.ac.uk/collection/P01/current/LENTRACK/",
           measurementType == "volume_filtered" ~ "http://vocab.nerc.ac.uk/collection/P01/current/VOLWBSMP/",
           measurementType == "speed_tow" ~ "http://vocab.nerc.ac.uk/collection/P01/current/TOWSPEED/"),
  measurementUnit = case_when(
    measurementType == "tow_distance" ~ "meter",
    measurementType == "volume_filtered" ~ "cubic meter",
    measurementType == "speed_tow" ~ "meter per second"),
  measurementUnitID = case_when(
    measurementUnit == "meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULAA/",
    measurementUnit == "cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/MCUB/",
    measurementUnit == "meter per second" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UVAA/")) %>%
    select(eventID, measurementID, measurementType, measurementTypeID, measurementValue,
           measurementUnit, measurementUnitID)

bongo_emof <- bongo_abun %>%
  select(occurrenceID, lifeStage, sex, abundance) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = lifeStage:abundance,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(occurrenceID, measurementType, sep = "-"),
    measurementTypeID = case_when(
      measurementType == "lifeStage" ~ "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/",
      measurementType == "sex" ~ "http://vocab.nerc.ac.uk/collection/P01/current/ENTSEX01/",
      measurementType == "abundance" ~ "http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL01/"),
    measurementUnit = case_when(
      measurementType == "abundance" ~ "individuals per cubic meter"),
    measurementUnitID = case_when(
      measurementUnit == "individuals per cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UPMM/"),
    measurementValueID = case_when(
      measurementValue == "M" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S103/",
      measurementValue == "F" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
      measurementValue == "C6" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      measurementValue == "C5" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1112/",
      measurementValue == "C4" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
      measurementValue == "C3" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S118/",
      measurementValue == "C2" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S117/",
      measurementValue == "C1" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S111/",
      measurementValue == "juvenile" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1127/",
      measurementValue == "calyptopsis" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1118/",
      measurementValue == "egg" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1122/",
      measurementValue == "larva" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1128/",
      measurementValue == "nauplius" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1130/",
      measurementValue == "zoea" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1137/",
      measurementValue == "furcillia" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1123/",
      measurementValue == "nurse?" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1196/",
      measurementValue == "trochophore" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1192/",
      measurementValue == "larval colony" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1101/",
      measurementValue == "float" ~ "",
      measurementValue == "veliger" ~  "http://vocab.nerc.ac.uk/collection/S11/current/S1193/",
      measurementValue == "paralarva" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1194/",
      measurementValue == "eudoxid" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1195/",
      measurementValue == "gastrozoid" ~ "",
      measurementValue == "gas float" ~ "",
      measurementValue == "adult" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      measurementValue == "neochaete" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1197/"))

# Combine the emof extension data files:
bongo2019_2020_emof <- plyr::rbind.fill(bongo_sampling, bongo_emof)
bongo2019_2020_emof[is.na(bongo2019_2020_emof)] <- ""
bongo2019_2020_emof <- as.data.frame(bongo2019_2020_emof)

# Make sure the folder path exists already (e.g. ./Bongo/tidy_data)
write_csv(bongo2019_2020_emof, here("standardized_data", "bongo2019_2020_emof.csv"))
```

***

## Section 4. Basic QAQC

Run some basic QAQC tests to ensure compatibility with other data in OBIS.

``` {r bongo_visualizations, message = FALSE}

# Plot points on a map:
bongo_fnl$decimalLatitude <- as.numeric(bongo_fnl$decimalLatitude)
bongo_fnl$decimalLongitude <- as.numeric(bongo_fnl$decimalLongitude)
bongo_leaflet <- obistools::plot_map_leaflet(bongo_fnl)
bongo_map <- obistools::plot_map(bongo_fnl, zoom = TRUE)
ggsave(filename = "bongo_map.png", plot = bongo_map, path = here::here("standardized_data", "maps"))

# Check if all OBIS required fields are in the occurrence extension:
obistools::check_fields(bongo_occ)

# The only columns missing are eventDate, decimalLatitude and decimalLongitude, which are already included in the event core, so they don't have to be included in the occurrence extension.

# Check if all eventIDs in an extension have a matching eventID in the core:
obistools::check_extension_eventids(bongo_fnl, bongo_occ)

# Check if all eventDates follow correct format:
obistools::check_eventdate(bongo_fnl)

```
